# 6.0.2

## Enhancements

### Durable Storage

- [#16136](https://github.com/emqx/emqx/pull/16136) Improved resource management and performance for durable storage.

  Introduced a concept of durable storage database group.
  Certain resources (such as memtable size and disk usage quota) can be shared between the group members.

  Added the following new metrics (per DB group):

  - `emqx_ds_disk_usage`: Total size of SST files
  - `emqx_ds_write_buffer_memory_usage`: RocksDB memtable size
  - `emqx_ds_total_trash_size`: Disk usage by trash SST files

  Added the following group configurations:

  - `durable_storage.db_groups.<group>.storage_quota`: Soft quota for the SST files size
  - `durable_storage.db_groups.<group>.write_buffer_size`: Maximum memtable size
  - `durable_storage.db_groups.<group>.rocksdb_nthreads_high` and `durable_storage.db_groups.<group>.rocksdb_nthreads_low`:
  Size of RocksDB thread pools.

  Added a new alarm that is raised when the quota is exceeded: `db_storage_quota_exceeded:<DB>`.
  Please refer to the "Storage Quota" section of the documentation for more details.

  Default session checkpoint interval has been changed to 15s.

- [#16286](https://github.com/emqx/emqx/pull/16286) Optimize the default durable storage settings to reduce CPU load.

### Security

- [#16461](https://github.com/emqx/emqx/pull/16461) Support TLS 1.3 session ticket resumption.

  EMQX now supports TLS 1.3 session resumption using stateless session tickets, allowing clients to resume TLS sessions without server-side session state storage.

  Node-level configuration: `node.tls_stateless_tickets_seed` is the secret key seed for generating TLS 1.3 stateless session tickets.
  Listener-level configuration: `listeners.ssl.<name>.ssl_options.session_tickets` enables TLS 1.3 session resumption using stateless session tickets.
  Possible values are `disabled` (default), `stateless`, and `stateless_with_cert` (includes certificate information).

  Session tickets are only generated when `node.tls_stateless_tickets_seed` is configured (non-empty) and `session_tickets` is enabled in listener SSL options.
  If `session_tickets` is enabled but `node.tls_stateless_tickets_seed` is empty, session tickets will not be generated and an error log will be emitted when starting the listener.

  It also included a fix the TLS 1.2 session resumption configuration: previously, the `reuse_sessions` option for SSL listener did not take effect, i.e. EMQX always tried to enabled TLS 1.2 session resumption.
  Now it is possible to turn off.
  Please note that TLS 1.2 session resumption will be disabled by default starting version 6.2.0.

### Rule Engine

- [#16524](https://github.com/emqx/emqx/pull/16524) Enhanced base64 encoding and decoding functions in rule engine SQL with support for padding and URL-safe options.

  The `base64_encode` and `base64_decode` functions now support optional parameters to control encoding behavior:

  - **`no_padding`**: Encode or decode without padding characters (`=`). Useful when you need to remove padding from encoded strings or decode strings that don't have padding.
  - **`urlsafe`**: Use URL-safe base64 encoding/decoding. Replaces `+` with `-` and `/` with `_`, making the encoded string safe to use in URLs without encoding.

  You can use these options individually or combine them. When combining options, the order doesn't matter.

  **Examples in rule SQL:**

  Encode without padding:
  ```sql
  SELECT base64_encode(payload, 'no_padding') as encoded FROM "t/#"
  ```

  Encode with URL-safe characters:
  ```sql
  SELECT base64_encode(payload, 'urlsafe') as encoded FROM "t/#"
  ```

  Encode with both options (no padding and URL-safe):
  ```sql
  SELECT base64_encode(payload, 'no_padding', 'urlsafe') as encoded FROM "t/#"
  ```

  Decode URL-safe base64:
  ```sql
  SELECT base64_decode(payload, 'urlsafe') as decoded FROM "t/#"
  ```

  Decode unpadded URL-safe base64:
  ```sql
  SELECT base64_decode(payload, 'urlsafe', 'no_padding') as decoded FROM "t/#"
  ```

- [#16533](https://github.com/emqx/emqx/pull/16533) Added two new Variform expression helper functions `json_value` and `jwt_value` to extract values from JSON data and JWT tokens using dot-separated key paths.

  The `json_value` function extracts values from JSON binary strings using a dot-separated path to navigate nested structures.
  The `jwt_value` function decodes JWT token payloads and extracts claim values using the same path syntax.

  For example, if `username` is a JSON object, you can access field with `json_value(username, 'shop.floor')`;
  if `password` is JWT with a customized claim, you can access the nested value with `jwt_value(password, 'client_attrs.unitid')`.

- [#16539](https://github.com/emqx/emqx/pull/16539) Added support for keeping track of metric aliases when utilizing the `spb_decode` Rule Engine function.

  Now, after a device or edge of network (EoN) node publishes its `DBIRTH`/`NBIRTH` messages, alias mappings in said message will be stored and used when the client later uses `spb_decode` on a message matching the `DDATA`/`NDATA` topic patterns.  The original names of the metrics will be added to the output of `spb_decode`.

  Note: when executing fallback actions, the mapping is not available in the environment they run in.  This means that, if a fallback action republishes the undecoded `DDATA`/`NDATA` payload to a Sparkplug B `DDATA`/`NDATA` topic, the metric `name` fields will not be populated by the alias mapping.

### Performance

- [#16413](https://github.com/emqx/emqx/pull/16413) Improve subscription handling performance.

## Bug Fixes

### Core MQTT Functionalities

- [#16354](https://github.com/emqx/emqx/pull/16354) Fixed a crash in MQTT v5 connections caused by a type mismatch when processing the request-response-information property.

- [#16515](https://github.com/emqx/emqx/pull/16515) Fixed a bug that caused WebSocket connections to crash when receiving broker messages larger than the client's advertised `Maximum-Packet-Size`.

### Data Integration

- [#16265](https://github.com/emqx/emqx/pull/16265) Previously, the Kafka source connector performed health checks by verifying partition leader connectivity for all partitions.
  In a clustered deployment, each EMQX node is assigned only a subset of partitions, causing leader connections for unassigned partitions to remain idle.
  Since Kafka closes idle connections after a timeout (10 minutes by default), this behavior could trigger false connectivity alarms.

  The health check now verifies leader connectivity only for the partitions assigned to the current EMQX node, preventing unnecessary idle connections and false alarms.

- [#16542](https://github.com/emqx/emqx/pull/16542) Fixed an issue where Kafka producer connections could reconnect prematurely when Kafka was overloaded, causing excessive produce request retries.
  The request timeout is now automatically set to at least twice the metadata request timeout (with a minimum of 30 seconds),
  reducing unnecessary reconnections and retries when metadata requests take longer than expected.
  This is especially beneficial when metadata request timeout is configured to a small value.

- [#16352](https://github.com/emqx/emqx/pull/16352) Upgrade Apache Pulsar client to 2.1.2.

  When Pulsar producer action's `batch_size` is configured to `1`, the producer will now encode single messages instead of single-element batch.
  This should make consumers to share load using Key Share strategy.

- [#16383](https://github.com/emqx/emqx/pull/16383) Previously, when using IoTDB Connector with its RestAPI driver, credentials would not be checked during health checks.  Now, we send a no-op query during IoTDB connector health-check.  This allows to detect misconfiguration of client credentials early.

- [#16507](https://github.com/emqx/emqx/pull/16507) Previously, when an MQTT Source's Connector recovered after losing its connection, topics would not be re-subscribed and the Source would stop working until the Connector itself was restarted.  Now, the Source will re-subscribe upon reconnect.

### Clustering

- [#16269](https://github.com/emqx/emqx/pull/16269) Fixed an issue in the Cluster Link route replication protocol recovery sequence where re-bootstrapping was incorrectly skipped even though the remote side needed it.

- [#16317](https://github.com/emqx/emqx/pull/16317) Fixed an issue in Cluster Link garbage-collection logic that could accidentally remove live routes from the internal routing table in the proces of cleaning up stale route replication state. This problem occured only when multiple independent Cluster Links were set up, and some of these links went down for relatively long periods of time.

- [#16465](https://github.com/emqx/emqx/pull/16465) Upgraded `gen_rpc` to `3.5.1`.

  Prior to the `gen_rpc` upgrade, EMQX may experience long tail of crash logs due to connect timeout if a peer node is unreachable.
  The new version `gen_rpc` no longer has the long tail and converted crash logs to more readable `error` logs,
  and the frequent log `"failed_to_connect_server"` is also throttled to avoid spamming.

- [#16544](https://github.com/emqx/emqx/pull/16544) Improve robustness of cluster autoclean procedure.

  Previously, if autoclean feature was disabled during initial start of the node, it would never activate after configuration change.
  This fix resolves this issue.

### Upgrade

- [#16308](https://github.com/emqx/emqx/pull/16308) Fixed an issue where Multi-Factor Authentication (MFA) could not be enabled after upgrading EMQX from versions earlier than 5.3.0 due to incompatible login-user database records.

### Configuration Management

- [#16397](https://github.com/emqx/emqx/pull/16397) Add TLS certificate format validation before listener start.
  Added some basic validations when parsing the SSL listener config, and error level log is raised if invalid PEM files are found.
  For example: `invalid_pem_file_ignored` and `bad_keyfile_ignored`.
  This makes troubleshooting easier as admin is able to observe error when starting/reconfiguring, instead of troubleshooting TLS handshake failures.

### Access Control

- [#16423](https://github.com/emqx/emqx/pull/16423) Added support for verifying the 'aud' (audience) claim in JWT authentication.

  When the 'aud' claim is configured in `verify_claims`, the JWT token must include a valid 'aud' claim. The verification supports both string and array formats:

  - If 'aud' is a string, it must exactly match the expected value.
  - If 'aud' is an array, at least one element in the array must match the expected value.
  - Empty string or empty array will fail verification.
  - Missing 'aud' claim will fail verification when it's configured in verify_claims.

- [#16459](https://github.com/emqx/emqx/pull/16459) Fixed the ussue in SCRAM authentication HTTP API. Previously, incorrect user ID was returned for the created user in the user creation API call.

### Observability

- [#16417](https://github.com/emqx/emqx/pull/16417) Reduced the volume of logs generated when a resource exception occurs (`resource_exception`).  These logs are now throttled, and some potentially large terms are redacted from it.

- [#16537](https://github.com/emqx/emqx/pull/16537) Fixed formatter crash when logging `gen_rpc` errors.

  Prior to this fix, EMQX may report "FORMATTER CRASH" errors when `gen_rpc` logged certain error messages (e.g., transmission timeout errors).
  The formatter now handles these error messages correctly without crashing.
