name: Generate Changelog Entry on Label

on:
  pull_request:
    types: [labeled]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  generate-changelog:
    if: github.event.label.name == 'generate-changelog'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Base Repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        # We check out the base repository to ensure we use the trusted script version.
        with:
          ref: ${{ github.base_ref }}

      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@7e473efe3cb98aa54f8d4bac15400b15fad77d94 # v2.2.0
        with:
          app-id: ${{ vars.AUTH_APP_ID }}
          private-key: ${{ secrets.AUTH_APP_PRIVATE_KEY }}

      - name: Generate Changelog
        run: ./scripts/generate-changelog.sh
        env:
          # The script will automatically pick up these environment variables.
          GITHUB_PULL_REQUEST_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_HEAD_REF: ${{ github.event.pull_request.head.ref }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
