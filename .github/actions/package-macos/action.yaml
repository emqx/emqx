name: 'Create MacOS package'
description: 'Build MacOS package for emqx or emqx-enterprise'
inputs:
  profile: # emqx, emqx-enterprise
    required: true
    type: string
  otp:
    required: true
    type: string
  os:
    required: false
    type: string
    default: macos-15
  apple_id_password:
    required: false
    type: string
  apple_developer_identity:
    required: false
    type: string
  apple_developer_id_bundle:
    required: false
    type: string
  apple_developer_id_bundle_password:
    required: false
    type: string

runs:
  using: composite
  steps:
    - name: Install dependencies
      shell: bash
      run: |
        brew update
        brew install curl zip unzip unixodbc coreutils freetds autoconf automake cmake openssl kerl
        brew upgrade curl zip unzip unixodbc coreutils freetds autoconf automake cmake openssl kerl
    - uses: actions/cache@d4323d4df104b026a6aa633fdb11d772146be0bf # v4.2.2
      id: cache
      with:
        path: ~/.kerl/installations/${{ inputs.otp }}
        key: otp-install-${{ inputs.otp }}-${{ inputs.os }}-disable-jit-20250325
    - name: build erlang
      if: steps.cache.outputs.cache-hit != 'true'
      shell: bash
      env:
        OTP_VERSION: ${{ inputs.otp }}
      run: |
        export LDFLAGS="-L$(brew --prefix unixodbc)/lib"
        export CC="/usr/bin/gcc -I$(brew --prefix unixodbc)/include"
        export KERL_CONFIGURE_OPTIONS="--disable-jit --with-ssl=$(brew --prefix openssl) --with-odbc=$(brew --prefix unixodbc)"
        export MAKEFLAGS=-j$(nproc)
        kerl build git https://github.com/emqx/otp.git OTP-$OTP_VERSION $OTP_VERSION
        kerl install $OTP_VERSION ~/.kerl/installations/$OTP_VERSION
        unset LDFLAGS
        unset CC
    - name: build
      shell: bash
      env:
        PROFILE: ${{ inputs.profile }}
        OTP_VERSION: ${{ inputs.otp }}
        APPLE_SIGN_BINARIES: 1
        APPLE_ID: developers@emqx.io
        APPLE_TEAM_ID: 26N6HYJLZA
        APPLE_ID_PASSWORD: ${{ inputs.apple_id_password }}
        APPLE_DEVELOPER_IDENTITY: ${{ inputs.apple_developer_identity }}
        APPLE_DEVELOPER_ID_BUNDLE: ${{ inputs.apple_developer_id_bundle }}
        APPLE_DEVELOPER_ID_BUNDLE_PASSWORD: ${{ inputs.apple_developer_id_bundle_password }}
      run: |
        . ~/.kerl/installations/$OTP_VERSION/activate
        # inspect erl in PATH
        which erl
        # inspect erl command banner
        erl -s init stop
        make ensure-rebar3
        mkdir -p $HOME/bin
        cp rebar3 $HOME/bin/rebar3
        export PATH="$HOME/bin:$PATH"
        make $PROFILE-tgz
    - name: test ${{ inputs.profile }}
      shell: bash
      env:
        PROFILE: ${{ inputs.profile }}
        OTP_VERSION: ${{ inputs.otp }}
      run: |
        . ~/.kerl/installations/$OTP_VERSION/activate
        pkg_name=$(find _packages/$PROFILE -mindepth 1 -maxdepth 1 -iname \*.zip)
        mkdir emqx
        unzip -d emqx $pkg_name > /dev/null
        ./emqx/bin/emqx start || cat emqx/log/erlang.log.1
        ./scripts/test/emqx-smoke-test.sh 127.0.0.1 18083
        ./emqx/bin/emqx ping
        ./emqx/bin/emqx help
        ./emqx/bin/emqx ctl status
        ./emqx/bin/emqx stop || cat emqx/log/erlang.log.1
        rm -rf emqx
